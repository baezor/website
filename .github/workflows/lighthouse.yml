name: Lighthouse CI
on:
  pull_request:
    branches: [main]

permissions:
  pull-requests: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for Cloudflare Pages deployment
        uses: WalshyDev/cf-pages-await@v1
        id: cf-pages
        with:
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          apiToken: ${{ secrets.CF_API_TOKEN }}
          project: baezor

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: ${{ steps.cf-pages.outputs.url }}
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Post results as comment
        uses: actions/github-script@v7
        with:
          script: |
            const results = ${{ steps.lighthouse.outputs.manifest }};
            const links = ${{ steps.lighthouse.outputs.links }};
            const summary = results[0].summary;

            const score = (v) => Math.round(v * 100);
            const emoji = (v) => v >= 0.9 ? 'ðŸŸ¢' : v >= 0.5 ? 'ðŸŸ ' : 'ðŸ”´';

            const body = `## âš¡ Lighthouse Results

            | Category | Score |
            |----------|-------|
            | ${emoji(summary.performance)} Performance | ${score(summary.performance)} |
            | ${emoji(summary.accessibility)} Accessibility | ${score(summary.accessibility)} |
            | ${emoji(summary['best-practices'])} Best Practices | ${score(summary['best-practices'])} |
            | ${emoji(summary.seo)} SEO | ${score(summary.seo)} |

            [Full Report](${Object.values(links)[0]})
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
